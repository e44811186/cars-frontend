<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    .cabinet-nav {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .cabinet-nav a {
      cursor: pointer;
      font-weight: bold;
      text-decoration: none;
      color: #333;
      padding: 6px 12px;
      border-radius: 6px;
      background: #f5f5f5;
    }
    .cabinet-nav a.active { background: #007bff; color: #fff; }
    .cabinet-section { display: none; }
    .cabinet-section.active { display: block; }
    .car-card {
      border: 1px solid #ddd;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .car-actions button { margin-left: 8px; }
    form input, form textarea, form select { display: block; width: 100%; margin: 6px 0; padding: 8px; }
    .auth-section { max-width: 400px; margin: 20px auto; }
  </style>
</head>
<body>
<header class="header">
  <div class="container header-row">
    <a href="index.html" class="logo"><img src="images/logo.png" alt="Logo"></a>
    <a href="index.html" class="button small-btn">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </div>
</header>

<section class="cabinet container">
  <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>

  <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è / —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
  <div id="auth" class="auth-section">
    <h3>–í–æ–π—Ç–∏</h3>
    <form id="loginForm">
      <input type="text" name="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
      <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
      <button type="submit" class="button">–í–æ–π—Ç–∏</button>
    </form>
    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
    <form id="registerForm">
      <input type="text" name="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
      <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
      <button type="submit" class="button">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </form>
  </div>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫–∞–±–∏–Ω–µ—Ç–∞ (—Å–∫—Ä—ã—Ç–∞ –¥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) -->
  <nav id="cabinetNav" class="cabinet-nav" style="display:none;">
    <a class="active" data-tab="my-cars">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</a>
    <a data-tab="add-car">–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ</a>
    <a data-tab="orders">–ó–∞—è–≤–∫–∏</a>
    <a id="logoutBtn">–í—ã–π—Ç–∏</a>
  </nav>

  <!-- –ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
  <div id="my-cars" class="cabinet-section active"></div>

  <!-- –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ -->
  <div id="add-car" class="cabinet-section">
    <form id="addCarForm">
      <input type="text" name="brand" placeholder="–ú–∞—Ä–∫–∞" required>
      <input type="text" name="model" placeholder="–ú–æ–¥–µ–ª—å" required>
      <input type="number" name="year" placeholder="–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞" required>
      <input type="number" name="price" placeholder="–¶–µ–Ω–∞ –≤ —Å—É—Ç–∫–∏" required>
      <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
      <input type="file" name="photo">
      <button type="submit" class="button">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
  </div>

  <!-- –ó–∞—è–≤–∫–∏ -->
  <div id="orders" class="cabinet-section"></div>
</section>

<footer class="footer">
  <div class="container">
    <div class="logo"><img src="images/logo.png" alt="Logo"></div>
    <div class="rights">–í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</div>
  </div>
</footer>

<script>
  const API_URL = "https://—Ç–≤–æ–µ-–¥–æ–º–µ–Ω–Ω–æ–µ-–∏–º—è/api"; // –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å API
  let token = localStorage.getItem('token');

  const authSection = document.getElementById('auth');
  const navBar = document.getElementById('cabinetNav');
  const myCarsDiv = document.getElementById('my-cars');
  const ordersDiv = document.getElementById('orders');
  const addCarForm = document.getElementById('addCarForm');

  // ---------------- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ----------------
  function setAuth(tokenValue) {
    token = tokenValue;
    localStorage.setItem('token', token);
    authSection.style.display = 'none';
    navBar.style.display = 'flex';
    loadMyCars();
    loadOrders();
  }

  document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const res = await fetch(`${API_URL}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: form.username.value,
        password: form.password.value
      })
    });
    if (res.ok) {
      const data = await res.json();
      setAuth(data.token);
    } else {
      alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
    }
  });

  document.getElementById('registerForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const res = await fetch(`${API_URL}/auth/dto/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: form.username.value,
        password: form.password.value
      })
    });
    if (res.ok) {
      alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ. –í–æ–π–¥–∏—Ç–µ.');
    } else {
      alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    token = null;
    localStorage.removeItem('token');
    location.reload();
  });

  // ---------------- –ù–∞–≤–∏–≥–∞—Ü–∏—è ----------------
  document.querySelectorAll('.cabinet-nav a[data-tab]').forEach(link => {
    link.addEventListener('click', () => {
      document.querySelectorAll('.cabinet-nav a').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      document.querySelectorAll('.cabinet-section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(link.dataset.tab).classList.add('active');
    });
  });

  // ---------------- –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π ----------------
  async function loadMyCars() {
    if (!token) return;
    myCarsDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    const res = await fetch(`${API_URL}/cars/mine`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (res.ok) {
      const cars = await res.json();
      myCarsDiv.innerHTML = cars.map(car => `
        <div class="car-card">
          <div>
            <strong>${car.brand} ${car.model}</strong><br>
            ${car.year}, ${car.color || '‚Äî'}, ${car.price}‚ÇΩ/—Å—É—Ç–∫–∏
          </div>
          <div class="car-actions">
            <button class="button small-btn" onclick="editCar(${car.id})">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="button small-btn" onclick="deleteCar(${car.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `).join('');
    } else {
      myCarsDiv.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
    }
  }

  // ---------------- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ ----------------
  addCarForm.addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(addCarForm);
    const obj = Object.fromEntries(formData.entries());
    const res = await fetch(`${API_URL}/cars`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(obj)
    });
    if (res.ok) {
      alert('–ê–≤—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
      addCarForm.reset();
      loadMyCars();
    } else {
      alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
    }
  });

  // ---------------- –ó–∞—è–≤–∫–∏ ----------------
  async function loadOrders() {
    if (!token) return;
    ordersDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    const res = await fetch(`${API_URL}/orders/mine`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (res.ok) {
      const orders = await res.json();
      ordersDiv.innerHTML = orders.map(order => `
        <div class="car-card">
          <div>
            <strong>–ó–∞—è–≤–∫–∞ –Ω–∞ ${order.car.brand} ${order.car.model}</strong><br>
            –ö–ª–∏–µ–Ω—Ç: ${order.clientName}, —Ç–µ–ª. ${order.clientPhone}
          </div>
          <div>
            <button class="button small-btn" onclick="confirmOrder(${order.id})">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button class="button small-btn" onclick="rejectOrder(${order.id})">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          </div>
        </div>
      `).join('');
    } else {
      ordersDiv.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫';
    }
  }

  async function confirmOrder(id) {
    await fetch(`${API_URL}/orders/${id}/confirm`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    loadOrders();
  }

  async function rejectOrder(id) {
    await fetch(`${API_URL}/orders/${id}/reject`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    loadOrders();
  }

  // ---------------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ----------------
  if (token) {
    setAuth(token);
  }
</script>
</body>
</html>
